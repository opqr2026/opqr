<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Continue</title>

    <link 
        rel="stylesheet" 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    >

    <style>
        body {
            background-color: #f4f6f8;
            font-family: Arial, sans-serif;
            margin: 0;
            text-align: center;
        }

        .dc-header {
            background-color: #990000;
            color: white;
            padding: 22px 0;
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: 0.6px;
            text-transform: uppercase;
        }

        .dc-stars {
            margin: 0;
            padding: 6px 0;
        }

        .dc-stars .star {
            color: #990000;
            font-size: 32px;
            margin: 0 12px;
        }

        .dc-stripe {
            height: 14px;
            background-color: #990000;
        }

        h2 {
            font-size: 2.2rem;
            margin-top: 50px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #222;
        }

        p {
            font-size: 1.2rem;
            margin-bottom: 45px;
            color: #555;
        }

        .continue-btn {
            font-size: 1.7rem;
            padding: 22px 50px;
            border-radius: 14px;
            width: 100%;
            max-width: 440px;
        }

        .footer {
            margin-top: 70px;
            font-size: 0.95rem;
            color: #777;
            padding-bottom: 30px;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
</head>

<body>

    <div class="dc-header">District of Columbia &#8226; Office of Planning</div>

    <div class="dc-stars">
        <span class="star">★</span>
        <span class="star">★</span>
        <span class="star">★</span>
    </div>

    <div class="dc-stripe"></div>
    <div class="dc-stripe"></div>

    <div class="container">

        <h2 id="titleText">Continue</h2>
        <p>Thank you for scanning. Tap below to proceed.</p>

        <a id="continueLink" href="#" class="btn btn-primary btn-lg continue-btn disabled">
            Please wait...
        </a>

        <div class="footer">
            © District of Columbia Government
        </div>
    </div>

<script>
async function sendScanData(payload) {
    try {
        await fetch("https://prod-08.usgovtexas.logic.azure.us:443/workflows/3766c841413e41bc99ffa55f35ff0c8e/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=pIJyusbsfRnMk_dJDsFS4_sIDvIjjv3LgaXA_oX0PR0", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
    } catch (err) {
        console.error("Failed to send scan data:", err);
    }
}

async function processScan() {
    const params = new URLSearchParams(window.location.search);

    const poster = params.get("poster");
    const postedAtLocation = params.get("postedAtLocation");
    const project = params.get("project") || "dc2050";
    const geo = params.get("geo");
    const timestamp = new Date().toISOString();
    const userAgent = navigator.userAgent;

    let payload = {
        poster,
        postedAtLocation,
        lat: null,
        lon: null,
        accuracy: null,
        locationPermission: "not_requested",
        timestamp,
        project,
        userAgent
    };

    if (geo === "true" && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                payload.lat = pos.coords.latitude;
                payload.lon = pos.coords.longitude;
                payload.accuracy = pos.coords.accuracy;
                payload.locationPermission = "granted";

                await sendScanData(payload);
                enableContinueButton(project);
            },
            async () => {
                payload.locationPermission = "denied";
                await sendScanData(payload);
                enableContinueButton(project);
            }
        );
    } else {
        await sendScanData(payload);
        enableContinueButton(project);
    }
}

function enableContinueButton(project) {
    const params = new URLSearchParams(window.location.search);

    // Dynamic project site URL
    const projectSite = params.get("projectSite");

    // Fallback map
    const redirectMap = {
        "dc2050": "https://dc2050.dc.gov",
        "visionzero": "https://visionzero.dc.gov",
        "parks": "https://dpr.dc.gov"
    };

    const finalUrl = projectSite || redirectMap[project] || "https://dc.gov";

    const continueBtn = document.getElementById("continueLink");
    const titleText = document.getElementById("titleText");

    // Dynamic button + title text
    continueBtn.innerText = `Continue to ${project.toUpperCase()}`;
    titleText.innerText = `Continue to ${project.toUpperCase()}`;

    continueBtn.href = finalUrl;
    continueBtn.classList.remove("disabled");
}

processScan();
</script>

</body>
</html>

